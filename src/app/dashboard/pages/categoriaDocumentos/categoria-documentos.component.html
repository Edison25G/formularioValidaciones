<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-6">
	<div class="flex justify-between items-center mb-8">
		<h2 class="text-3xl font-bold text-gray-800">Categoría: {{ nombreCategoria | titlecase }}</h2>
		<p-button
			label="Limpiar Filtros"
			icon="pi pi-filter-slash"
			severity="secondary"
			rounded
			outlined
			size="small"
			pTooltip="Limpiar búsqueda y mes"
			tooltipPosition="top"
			(click)="limpiarFiltros()"
		></p-button>
	</div>

	<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 bg-white p-6 rounded-xl shadow-md">
		<div>
			<span class="block mb-2 text-sm font-semibold text-gray-700">Buscar Documento</span>

			<input
				pInputText
				[(ngModel)]="busqueda"
				(input)="filtrarDocumentos()"
				placeholder="Ej: Informe, Plan Estratégico..."
				class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-green-400"
			/>
		</div>
		<div>
			<span class="block mb-2 text-sm font-semibold text-gray-700">Filtrar por Mes</span>
			<p-select
				[options]="meses"
				[(ngModel)]="mesSeleccionado"
				(onChange)="filtrarDocumentos()"
				placeholder="Seleccione mes"
				class="w-full border border-gray-300 rounded-md"
			>
				<ng-template let-option pTemplate="item">
					<div class="px-4 py-2 hover:bg-green-100 hover:text-green-600 rounded cursor-pointer">
						{{ option.label }}
					</div>
				</ng-template>
			</p-select>
		</div>

		<div>
			<span class="block mb-2 text-sm font-semibold text-gray-700">Filtrar por Año</span>
			<p-select
				[options]="anios"
				[(ngModel)]="anioSeleccionado"
				(onChange)="filtrarDocumentos()"
				placeholder="Seleccione un año"
				class="w-full border border-gray-300 rounded-md"
			>
				<ng-template let-option pTemplate="item">
					<div class="px-4 py-2 hover:bg-green-100 hover:text-green-600 rounded cursor-pointer">
						{{ option.label }}
					</div>
				</ng-template>
			</p-select>
		</div>

		<div class="flex items-end">
			<p-button
				label="Aplicar Filtros"
				icon="pi pi-search"
				severity="success"
				rounded
				outlined
				size="small"
				pTooltip="Aplicar filtros"
				tooltipPosition="top"
				(click)="filtrarDocumentos()"
				class="w-full"
			></p-button>
		</div>
	</div>

	<div class="bg-white p-6 rounded-xl shadow-md mb-20">
		<ng-container *ngIf="documentosFiltrados.length > 0; else noDocumentos">
			<p-table
				[value]="documentosFiltrados"
				[paginator]="true"
				[rows]="10"
				[rowsPerPageOptions]="[5, 10, 20]"
				[responsiveLayout]="'scroll'"
				sortMode="multiple"
				class="p-datatable-sm shadow"
			>
				<ng-template pTemplate="header">
					<tr>
						<th pSortableColumn="name">
							Nombre
							<p-sortIcon field="name" />
						</th>
						<th pSortableColumn="month">
							Mes
							<p-sortIcon field="month" />
						</th>
						<th pSortableColumn="year">
							Año
							<p-sortIcon field="year" />
						</th>
						<th pSortableColumn="createdAt">
							Fecha de subida
							<p-sortIcon field="createdAt" />
						</th>
						<th>Acciones</th>
					</tr>
				</ng-template>

				<ng-template pTemplate="body" let-doc let-i="rowIndex">
					<tr>
						<td class="whitespace-nowrap text-left">
							<div class="flex items-center gap-2 min-w-0">
								<i [class]="obtenerIcono(doc)" class="text-green-500 text-xl flex-shrink-0"></i>
								<span class="truncate w-full" pTooltip="{{ doc.name }}">{{ doc.name }}</span>
							</div>
						</td>

						<td class="whitespace-nowrap text-center text-sm text-gray-700">
							{{ doc.mes }}
						</td>

						<td class="whitespace-nowrap text-center text-sm text-gray-700">
							{{ doc.anio }}
						</td>

						<td class="whitespace-nowrap text-center text-sm text-gray-700">
							{{ doc.createdAt | date: 'dd/MM/yyyy HH:mm' }}
						</td>

						<td class="whitespace-nowrap text-center">
							<div class="flex justify-center items-center gap-2">
								<p-button
									*ngIf="puedeVer"
									icon="pi pi-eye"
									severity="info"
									rounded
									outlined
									size="small"
									pTooltip="Vista previa"
									tooltipPosition="top"
									(click)="verDocumento(doc)"
								></p-button>

								<p-button
									*ngIf="puedeDescargar"
									icon="pi pi-download"
									severity="success"
									rounded
									outlined
									size="small"
									pTooltip="Descargar"
									tooltipPosition="top"
									(click)="descargarDocumento(doc)"
								></p-button>

								<p-button
									*ngIf="puedeImprimir"
									icon="pi pi-print"
									severity="warn"
									rounded
									outlined
									size="small"
									pTooltip="Imprimir"
									tooltipPosition="top"
									(click)="imprimirDocumento(doc)"
								></p-button>

								<span
									*ngIf="!puedeVer && !puedeDescargar && !puedeImprimir"
									class="text-gray-400 text-sm italic flex items-center gap-1"
									pTooltip="Sin permisos para acciones"
									tooltipPosition="top"
								>
									<i class="pi pi-lock text-red-400"></i> Sin permisos
								</span>
							</div>
						</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="5" class="text-center text-gray-500 py-10">
							<i class="pi pi-file" style="font-size: 3rem"></i>
							<p class="mt-4">
								{{
									tieneDocumentosOriginales
										? 'No hay documentos que coincidan con los filtros aplicados.'
										: 'No hay documentos disponibles en esta categoría.'
								}}
							</p>
						</td>
					</tr>
				</ng-template>
			</p-table>
		</ng-container>
		<ng-template #noDocumentos>
			<div class="text-center text-gray-500 py-10">
				<i class="pi pi-file" style="font-size: 3rem"></i>
				<p class="mt-4">
					{{
						tieneDocumentosOriginales
							? 'No hay documentos que coincidan con los filtros aplicados.'
							: 'No hay documentos disponibles en esta categoría.'
					}}
				</p>
			</div>
		</ng-template>
	</div>

	<p-dialog
		header="Vista previa del Documento"
		[(visible)]="mostrarArchivo"
		[modal]="true"
		[style]="{ width: '90vw', height: '90vh' }"
		(onHide)="cerrarVista()"
	>
		<iframe
			*ngIf="archivoActual"
			[src]="archivoActual"
			width="100%"
			height="100%"
			frameborder="0"
			class="rounded-xl"
		></iframe>
	</p-dialog>
</div>
